const p=Symbol(),y=Symbol();let v;function b(r,t){v=new Set;const e=r(),s=v;v=null;const i=new AbortController,{signal:n}=i,h=()=>{i.abort(),b(r,t)};for(const g of s)g.addEventListener("change",h,{signal:n});return t.set(e),t}function c(r){if(typeof r=="function")return b(r,c({})._);r=c.get(r);const t={isObject:!0,isRoot:!0,value:{_:r}},e=new f(t,"_"),{proxy:s}=e;return s.set(r),s}c.get=r=>r?.[p]?.value??r,c.made=r=>!!r?.[p],c.typeof=r=>typeof c.get(r);class f{static children=new WeakMap;target=new EventTarget;specials={toJSON:()=>this.value,is:t=>this.value==c.get(t),get:()=>this.value,set:t=>this.change(()=>this.object[this.key]=c.get(t)),delete:()=>this.change(()=>delete this.object?.[this.key]),free:()=>this.isEmpty,typeof:()=>typeof this.value,addEventListener:(...t)=>this.target.addEventListener(...t),removeEventListener:(...t)=>this.target.removeEventListener(...t),dispatchEvent:(...t)=>this.target.dispatchEvent(...t)};constructor(t,e){const s=f.children.get(t),i=s?.[e];if(i)return i;s?s[e]=this:f.children.set(t,{[e]:this}),this.parent=t,this.key=e;const n={};n.get=(u,o)=>this.get(o),n.set=(u,o,l)=>this.proxy[o].set(l),n.deleteProperty=(u,o)=>this.proxy[o].delete(),n.apply=(u,...o)=>this.callback.apply(...o);const h=(u,o)=>n[o]??((l,...d)=>Reflect.has(this.value,...d)),g=new Proxy(n,{get:h});this.proxy=new Proxy(function(){},g)}get callback(){return this.parent.getCallback?.(this.key)}get object(){return this.parent.value}get value(){return this.object?.[this.key]}get isEmpty(){return!this.parent.isObject}get isObject(){return typeof this.value=="object"&&this.value!=null}get isArray(){return Array.isArray(this.value)}get detail(){const t=this.proxy,e=this.parent.isRoot?null:this.key,s=this.parent?.proxy??null;return{source:t,key:e,parent:s,stopPropagation:function(){this[y]=!0}}}change(t){const e=this.value;t();const{value:s,key:i}=this;return this.dispatchChange(s,e,this.detail),!0}dispatchChange(t,e,s){if(t===e)return;const i=!s;s??=this.detail;const n={value:t,oldValue:e,...s};this.target.dispatchEvent(new CustomEvent("change",{detail:n})),!(i||n[y])&&this.parent.dispatchChange?.(t,e,s)}get(t){if(t==p)return this;if(t==Symbol.toPrimitive)return this.isObject?void 0:()=>this.value;if(t=="valueOf")return()=>this.value;if(t=="toString")return()=>this.value.toString();const{proxy:e}=new f(this,t);return v?.add(e),e}getCallback(t){if(this.specials[t])return this.specials[t];if(typeof this.value[t]=="function")return this.isArray?(...e)=>this.callArrayMethod(this.value,t,e):this.value[t].bind(this.value)}isPropertyReference(t){return this.isEmpty||!this.isObject?!1:this.isArray?typeof t=="symbol"||t<0?!1:!!Number.isInteger(+t):!0}callArrayMethod(t,e,s){const i=[...t],n=t,h=t[e](...s);if(!(i.length!=n.length||n.some((a,x)=>a!==i[x])))return h;const u=Math.max(i.length,n.length),o=[];for(let a=0;a<u;a++)n[a]!==i[a]&&o.push(a);const l=o.pop(),{proxy:d,detail:m}=this;for(const a of o)d[a][p].dispatchChange(n[a],i[a]);return d[l][p].dispatchChange(n[l],i[l],m),h}}export{c as default};
